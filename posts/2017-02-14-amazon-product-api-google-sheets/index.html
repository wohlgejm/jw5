<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    <title>Amazon api requests from google sheets</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="Amazon api requests from google sheets">
    <meta property="og:type" content="">
    <meta property="og:url" content="https://jw5.dev">
    <meta property="og:image" content="">

    <link rel="apple-touch-icon" href="/jw5/img/favicon.ico">
    <link rel="shortcut icon" type="image/jpg" href="/jw5/img/favicon.ico"/>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300&display=swap" rel="stylesheet">

    <!-- Prism Syntax Highlighting -->
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">

    <!-- Tachyons-->
    <link rel="stylesheet" href="https://unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Local styles-->
    <link rel="stylesheet" href="/jw5/styles/main.css">

    <meta name="theme-color" content="#fafafa">
    </head>

    <body>
      <div class="mw7 mw7-ns center pa3 ph5-ns" >
        <a href="/jw5/" class="flex items-center bb no-underline black">
            <img src="/jw5/img/waveemoji.svg" alt="Wave" width="50" height="50" />
            <h1 class="ml4">I'm Jerry Wohlgemuth.</h1>
        </a>

        <div class="flex pa3 justify-center">
            <div><a href="/jw5/about">about me</a></div>
            <div class="ml4"><a href="mailto:wohlgejm@gmail.com">email</a></div>
            <div class="ml4"><a href="https://www.linkedin.com/in/wohlgejm" rel="noreferrer" target="_blank">linkedin</a></div>
        </div>
        <p>Here is some javascript code to sign requests for the Amazon Product Advertising API in Google Sheets. This uses
v2 of Amazon's signing process, so you can adopt it to use other AWS services. It uses Google's <code>Utilities</code> service
to handle the crypto. The URI encoding also needs to be strict (see this <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">article</a>).</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fixedEncodeURIComponent</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[!'()*]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token string">'%'</span> <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">AwsSigner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>accessKey <span class="token operator">=</span> <span class="token string">'youraccesskey'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>secretKey <span class="token operator">=</span> <span class="token string">'yoursecretkey'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>associateId <span class="token operator">=</span> <span class="token string">'yourassociateid'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> <span class="token string">'webservices.amazon.com'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'GET'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint <span class="token operator">=</span> <span class="token string">'http://webservices.amazon.com/onca/xml'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/onca/xml'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> <span class="token string">'AWSECommerceService'</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'2013-08-01'</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token class-name">AwsSigner</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">url</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>params <span class="token operator">=</span> params<span class="token punctuation">;</span><br>  signature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stringToSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint <span class="token operator">+</span> <span class="token string">'?'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&amp;Signature='</span> <span class="token operator">+</span> <span class="token function">fixedEncodeURIComponent</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token class-name">AwsSigner</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">signature</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> Utilities<span class="token punctuation">.</span><span class="token function">base64Encode</span><span class="token punctuation">(</span>Utilities<span class="token punctuation">.</span><span class="token function">computeHmacSha256Signature</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>secretKey<span class="token punctuation">,</span> Utilities<span class="token punctuation">.</span>Charset<span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token class-name">AwsSigner</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">stringToSign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> <span class="token string">'/onca/xml'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token class-name">AwsSigner</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">queryString</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  str <span class="token operator">=</span> <span class="token string">'AWSAccessKeyId='</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accessKey<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'AssociateTag'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>associateId<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'Timestamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>date<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'Version'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span><br>  <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">;</span><br>  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    str <span class="token operator">+=</span> <span class="token string">'&amp;'</span> <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">fixedEncodeURIComponent</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> str<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">var</span> signer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AwsSigner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> url <span class="token operator">=</span> signer<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token string">'ItemId'</span><span class="token operator">:</span> <span class="token string">'SOMEASIN'</span><span class="token punctuation">,</span><br>  <span class="token string">'Operation'</span><span class="token operator">:</span> <span class="token string">'ItemLookup'</span><span class="token punctuation">,</span><br>  <span class="token string">'ResponseGroup'</span><span class="token operator">:</span> <span class="token string">'ItemAttributes'</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

      </div>
    </body>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CY25JVKR0D"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CY25JVKR0D');
    </script>
</html>
