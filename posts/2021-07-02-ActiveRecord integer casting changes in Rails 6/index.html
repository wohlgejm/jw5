<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ActiveRecord integer casting changes in Rails 6</title>
    <meta name="description" content="Personal website of Jerry Wohlgemuth." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="og:title" content="ActiveRecord integer casting changes in Rails 6" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="https://jw5.dev" />
    <meta property="og:image" content="" />

    <link rel="apple-touch-icon" href="/img/favicon.ico" />
    <link rel="shortcut icon" type="image/jpg" href="/img/favicon.ico" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300&display=swap"
      rel="stylesheet"
    />

    <!-- Prism Syntax Highlighting -->
    <link
      href="https://unpkg.com/prismjs@1.20.0/themes/prism.css"
      rel="stylesheet"
    />

    <!-- Tachyons-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/tachyons/css/tachyons.min.css"
    />

    <!-- Local styles-->
    <link rel="stylesheet" href="/styles/main.css" />

    <meta name="theme-color" content="#fafafa" />
  </head>

  <body>
    <div class="mw7 mw7-ns center pa3 ph5-ns">
      <a href="/" class="flex items-center bb no-underline black">
        <img src="/img/waveemoji.svg" alt="Wave" width="50" height="50" />
        <h1 class="ml4">I'm Jerry Wohlgemuth.</h1>
      </a>

      <div class="flex pa3 justify-center">
        <div><a href="/about">about me</a></div>
        <div class="ml4"><a href="mailto:wohlgejm@gmail.com">email</a></div>
        <div class="ml4">
          <a
            href="https://www.linkedin.com/in/wohlgejm"
            rel="noreferrer"
            target="_blank"
            >linkedin</a
          >
        </div>
      </div>
      
<h3 class="tc"> ActiveRecord integer casting changes in Rails 6</h1>
<h5 class="tc"> 2021-07-02</h1>
<main><p>ActiveRecord often goes out of its way to guess your intent when querying. For example, it will convert strings to integers if that is the column type being queries.</p>
<p>You can easily check the output of the conversion like this:</p>
<pre class="language-ruby"><code class="language-ruby"><span class="token constant">Model</span><span class="token punctuation">.</span>arel_table<span class="token punctuation">[</span><span class="token symbol">:id</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type_cast_for_database<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><br><span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span></code></pre>
<p>In Rails 6, the serialization method changed. Maybe you were accepting some params from a controller and doing something like:</p>
<pre class="language-ruby"><code class="language-ruby"><span class="token constant">Model</span><span class="token punctuation">.</span>where<span class="token punctuation">.</span><span class="token keyword">not</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'temporary-id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>In Rails 5, the following query would be generated:</p>
<pre class="language-ruby"><code class="language-ruby"><span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> users <span class="token constant">WHERE</span> id <span class="token constant">NOT</span> <span class="token constant">IN</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre>
<p>This query would run as you expect and return all the records except 1 and 2 since the primary key <code>id</code> is â‰¥ 1.</p>
<p>In Rails 6, this query would be executed:</p>
<pre class="language-ruby"><code class="language-ruby"><span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> users <span class="token constant">WHERE</span> id <span class="token constant">NOT</span> <span class="token constant">IN</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre>
<p>Now, the result set is completely different. Because the string was serialized as <code>NULL</code> and the <code>id</code> field will never be <code>NULL</code> this will always return an empty relation.</p>
<p>This is kind of a fringe case and you probably shouldn't be passing in those string params in the first place, but serialization is something to watch out for when accepting user input and upgrading your Rails versions.</p>
</main>

<script src="https://utteranc.es/client.js"
        repo="wohlgejm/jw5"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

    </div>
  </body>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-CY25JVKR0D"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-CY25JVKR0D");
  </script>
</html>
