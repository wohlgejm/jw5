<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    <title>Flight costs in Google sheets</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="Flight costs in Google sheets">
    <meta property="og:type" content="">
    <meta property="og:url" content="https://jw5.dev">
    <meta property="og:image" content="">

    <link rel="apple-touch-icon" href="/img/favicon.ico">
    <link rel="shortcut icon" type="image/jpg" href="/img/favicon.ico"/>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300&display=swap" rel="stylesheet">

    <!-- Prism Syntax Highlighting -->
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">

    <!-- Tachyons-->
    <link rel="stylesheet" href="https://unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Local styles-->
    <link rel="stylesheet" href="/styles/main.css">

    <meta name="theme-color" content="#fafafa">
    </head>

    <body>
      <div class="mw7 mw7-ns center pa3 ph5-ns" >
        <a href="/" class="flex items-center bb no-underline black">
            <img src="/img/waveemoji.svg" alt="Wave" width="50" height="50" />
            <h1 class="ml4">I'm Jerry Wohlgemuth.</h1>
        </a>

        <div class="flex pa3 justify-center">
            <div><a href="/about">about me</a></div>
            <div class="ml4"><a href="mailto:wohlgejm@gmail.com">email</a></div>
            <div class="ml4"><a href="https://www.linkedin.com/in/wohlgejm" rel="noreferrer" target="_blank">linkedin</a></div>
        </div>
        <p>The ability write your own javascript functions in Google sheets is incredibly powerful. I'm working in a sheet
and I wanted the ability to include flight costs.</p>
<p>Apparent flight cost data is well guarded and the only solution was to use Google's
<a href="https://developers.google.com/qpx-express/v1/requests">QPX Express API</a>. You are limited to 50 queries
a day, but to get around this, we can use caching/persistence (which is built into Google scripts).</p>
<p>You'll need to set up an API key in the <a href="https://console.developers.google.com/apis">Google Developer Console</a> and enable QPX Express.
Once that is set up, you can use the following two functions in your sheets that take a depart date, return date,
origin and destination.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> apiKey <span class="token operator">=</span> <span class="token string">'apiKeyGoesHere'</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'https://www.googleapis.com/qpxExpress/v1/trips/search?key='</span> <span class="token operator">+</span> apiKey<span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">formatDate</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> d<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">var</span> Flight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">function</span> <span class="token function">Flight</span><span class="token punctuation">(</span><span class="token parameter">departDate<span class="token punctuation">,</span> returnDate<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> destination</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">=</span> origin<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>destination <span class="token operator">=</span> destination<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>departDate <span class="token operator">=</span> <span class="token function">formatDate</span><span class="token punctuation">(</span>departDate<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>returnDate <span class="token operator">=</span> <span class="token function">formatDate</span><span class="token punctuation">(</span>returnDate<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> PropertiesService<span class="token punctuation">.</span><span class="token function">getDocumentProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> origin <span class="token operator">+</span> destination <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>departDate <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnDate <span class="token operator">+</span> <span class="token string">'v2'</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token class-name">Flight</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">cost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">getInfo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cost<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token class-name">Flight</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">flightNumber</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">getInfo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flightNumber<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> stored <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>stored <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>stored<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token function">fetchInfo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">fetchInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>UrlFetchApp<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token function">options</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> cost <span class="token operator">=</span> response<span class="token punctuation">.</span>trips<span class="token punctuation">.</span>tripOption<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>saleTotal<span class="token punctuation">;</span><br>    <span class="token keyword">var</span> carrier <span class="token operator">=</span> response<span class="token punctuation">.</span>trips<span class="token punctuation">.</span>tripOption<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>segment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flight<span class="token punctuation">.</span>carrier<span class="token punctuation">;</span><br>    <span class="token keyword">var</span> number <span class="token operator">=</span> response<span class="token punctuation">.</span>trips<span class="token punctuation">.</span>tripOption<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>segment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flight<span class="token punctuation">.</span>number<span class="token punctuation">;</span><br><br>    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><br>      cost<span class="token operator">:</span> cost<span class="token punctuation">,</span><br>      flightNumber<span class="token operator">:</span> carrier <span class="token operator">+</span> number<br>    <span class="token punctuation">}</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> data<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>      method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span><br>      payload<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">payload</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      contentType<span class="token operator">:</span> <span class="token string">'application/json'</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>      request<span class="token operator">:</span> <span class="token punctuation">{</span><br>        slice<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><br>          origin<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">,</span><br>            destination<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destination<span class="token punctuation">,</span><br>            date<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>departDate<br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token punctuation">{</span><br>          origin<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destination<span class="token punctuation">,</span><br>          destination<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">,</span><br>          date<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnDate<br>          <span class="token punctuation">}</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      passengers<span class="token operator">:</span> <span class="token punctuation">{</span><br>          adultCount<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>          infantInLapCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>          infantInSeatCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>          childCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>          seniorCount<span class="token operator">:</span> <span class="token number">0</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        solutions<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        refundable<span class="token operator">:</span> <span class="token boolean">false</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> Flight<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token constant">FLIGHTCOST</span><span class="token punctuation">(</span><span class="token parameter">departDate<span class="token punctuation">,</span> returnDate<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> destination</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flight</span><span class="token punctuation">(</span>departDate<span class="token punctuation">,</span> returnDate<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token constant">FLIGHTNUMBER</span><span class="token punctuation">(</span><span class="token parameter">departDate<span class="token punctuation">,</span> returnDate<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> destination</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flight</span><span class="token punctuation">(</span>departDate<span class="token punctuation">,</span> returnDate<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">flightNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>If you don't want to persist the values, you can use Google's <code>CacheService</code> instead of <code>PropertiesService</code>, to
store results for up to 6 hours. I don't care about this updating in real time, so I opted to just persist it
to avoid rate limits on the API.</p>

      </div>
    </body>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CY25JVKR0D"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CY25JVKR0D');
    </script>
</html>
